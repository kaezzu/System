<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplier Management - Colegio de Muntinlupa</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        const API_BASE_URL = 'http://localhost:3000';
        let currentSort = { column: null, direction: 'asc' };
        let suppliers = [];

        // Check if user is logged in
        if (!sessionStorage.getItem('isLoggedIn')) {
            window.location.href = 'index.html';
        }

        function showAddSupplierModal() {
            document.getElementById('modalTitle').textContent = 'Add New Supplier';
            document.getElementById('supplierForm').reset();
            document.getElementById('supplierForm').action = '/supplier/add';
            document.getElementById('supplierModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('supplierModal').style.display = 'none';
            document.getElementById('supplierForm').reset();
        }

        function editSupplier(id) {
            fetch(`/supplier/${id}`)
                .then(response => response.json())
                .then(supplier => {
                    document.getElementById('modalTitle').textContent = 'Edit Supplier';
                    document.getElementById('companyName').value = supplier.name;
                    document.getElementById('contactPerson').value = supplier.contact || '';
                    document.getElementById('email').value = supplier.email || '';
                    document.getElementById('phone').value = supplier.phone || '';
                    document.getElementById('address').value = supplier.address || '';
                    document.getElementById('supplierForm').action = `/supplier/update/${id}`;
                    document.getElementById('supplierModal').style.display = 'flex';
                })
                .catch(error => {
                    console.error('Error loading supplier:', error);
                    alert('Error loading supplier details');
                });
        }

        function deleteSupplier(id) {
            if (confirm('Are you sure you want to delete this supplier?')) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/supplier/delete/${id}`;
                document.body.appendChild(form);
                form.submit();
            }
        }

        function logout() {
            sessionStorage.removeItem('isLoggedIn');
            window.location.href = 'index.html';
        }

        // Function to update user info in sidebar
        function updateUserInfo() {
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (currentUser) {
                document.getElementById('sidebarUserName').textContent = currentUser.username;
                document.getElementById('sidebarUserRole').textContent = formatRole(currentUser.role);
                document.getElementById('sidebarUserFullName').textContent = currentUser.fullName;
            }
        }

        function formatRole(role) {
            switch(role) {
                case 'department_head':
                    return 'Department Head';
                case 'logistic_officer':
                    return 'Logistic Officer';
                case 'member':
                    return 'Member';
                default:
                    return role;
            }
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            updateUserInfo();
            fetchSuppliers();
        });

        // Fetch and display suppliers
        async function fetchSuppliers() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/suppliers`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to fetch suppliers');
                }

                suppliers = data.suppliers || [];
                displaySuppliers();
            } catch (error) {
                console.error('Error:', error);
                const tableBody = document.getElementById('supplierTableBody');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-red-500">
                            Error loading suppliers: ${error.message}
                        </td>
                    </tr>
                `;
                showNotification(error.message, 'error');
            }
        }

        // Display suppliers in table
        function displaySuppliers() {
            const tableBody = document.getElementById('supplierTableBody');
            tableBody.innerHTML = '';

            if (suppliers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            No suppliers found
                        </td>
                    </tr>
                `;
                return;
            }

            suppliers.forEach(supplier => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-center">${supplier.supplier_id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">${supplier.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">${supplier.contact}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">${supplier.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">${supplier.Phone || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">${supplier.address || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center justify-center space-x-3">
                            <button onclick="editSupplier(${supplier.supplier_id})" 
                                class="inline-flex items-center justify-center px-2 py-1.5 border border-blue-600 text-blue-600 hover:bg-blue-50 rounded-md transition-colors duration-150"
                                title="Edit">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="deleteSupplier(${supplier.supplier_id})" 
                                class="inline-flex items-center justify-center px-2 py-1.5 border border-red-600 text-red-600 hover:bg-red-50 rounded-md transition-colors duration-150"
                                title="Delete">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Add new supplier
        async function addSupplier(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const supplierData = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`${API_BASE_URL}/api/suppliers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(supplierData)
                });

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to add supplier');
                }

                showNotification('Supplier added successfully', 'success');
                closeModal();
                form.reset();
                await fetchSuppliers();
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            }
        }

        // Edit supplier
        async function editSupplier(supplierId) {
            const supplier = suppliers.find(s => s.supplier_id === supplierId);
            if (!supplier) return;

            // Populate edit form
            const form = document.getElementById('editSupplierForm');
            form.elements['name'].value = supplier.name;
            form.elements['contact'].value = supplier.contact;
            form.elements['email'].value = supplier.email;
            form.elements['phone'].value = supplier.phone || '';
            form.elements['address'].value = supplier.address || '';
            form.dataset.supplierId = supplierId;

            openModal('editSupplierModal');
        }

        // Update supplier
        async function updateSupplier(event) {
            event.preventDefault();
            const form = event.target;
            const supplierId = form.dataset.supplierId;
            const formData = new FormData(form);
            const supplierData = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`${API_BASE_URL}/api/suppliers/${supplierId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(supplierData)
                });

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to update supplier');
                }

                showNotification('Supplier updated successfully', 'success');
                closeModal();
                form.reset();
                await fetchSuppliers();
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            }
        }

        // Delete supplier
        async function deleteSupplier(supplierId) {
            if (!confirm('Are you sure you want to delete this supplier?')) return;

            try {
                const response = await fetch(`${API_BASE_URL}/api/suppliers/${supplierId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to delete supplier');
                }

                showNotification('Supplier deleted successfully', 'success');
                await fetchSuppliers();
            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            }
        }

        // Search suppliers
        function searchSuppliers() {
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            const filteredSuppliers = suppliers.filter(supplier => 
                supplier.name.toLowerCase().includes(searchInput) ||
                supplier.contact.toLowerCase().includes(searchInput) ||
                supplier.email.toLowerCase().includes(searchInput)
            );
            displaySuppliers(filteredSuppliers);
        }

        // Sort suppliers
        function sortSuppliers(column) {
            const direction = currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc';
            currentSort = { column, direction };

            suppliers.sort((a, b) => {
                const aValue = a[column]?.toLowerCase() || '';
                const bValue = b[column]?.toLowerCase() || '';
                return direction === 'asc' 
                    ? aValue.localeCompare(bValue)
                    : bValue.localeCompare(aValue);
            });

            displaySuppliers();
            updateSortIndicators();
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            }`;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Update sort indicators
        function updateSortIndicators() {
            const headers = document.querySelectorAll('.header-cell');
            headers.forEach(header => {
                const column = header.dataset.column;
                if (column === currentSort.column) {
                    const direction = currentSort.direction === 'asc' ? 'up' : 'down';
                    header.innerHTML = `
                        ${header.textContent}
                        <i class="fas fa-sort-${direction} ml-2"></i>
                    `;
                } else {
                    header.innerHTML = header.textContent;
                }
            });
        }
    </script>
</head>
<body class="min-h-screen bg-secondary-50">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-lg">
            <div class="p-4 border-b border-secondary-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center">
                        <span class="text-xl">👤</span>
                    </div>
                    <div>
                        <p class="font-medium text-secondary-900" id="sidebarUserName">Loading...</p>
                        <p class="text-sm text-secondary-600" id="sidebarUserRole">Loading...</p>
                        <p class="text-xs text-secondary-500" id="sidebarUserFullName">Loading...</p>
                    </div>
                </div>
            </div>

            <nav class="p-4 space-y-2">
                <a href="dashboard.html" class="flex items-center space-x-3 px-4 py-2 text-secondary-600 hover:bg-secondary-50 rounded-lg transition-all duration-200 hover:text-primary-600">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    <span>Home</span>
                </a>
                <a href="inventory.html" class="flex items-center space-x-3 px-4 py-2 text-secondary-600 hover:bg-secondary-50 rounded-lg transition-all duration-200 hover:text-primary-600">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    <span>Inventory</span>
                </a>
                <a href="borrowed.html" class="flex items-center space-x-3 px-4 py-2 text-secondary-600 hover:bg-secondary-50 rounded-lg transition-all duration-200 hover:text-primary-600">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    <span>Borrowed Items</span>
                </a>
                <a href="user-activity.html" class="flex items-center space-x-3 px-4 py-2 text-secondary-600 hover:bg-secondary-50 rounded-lg transition-all duration-200 hover:text-primary-600">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <span>User Activity</span>
                </a>
                <a href="supplier.html" class="flex items-center space-x-3 px-4 py-2 bg-primary-50 text-primary-700 rounded-lg transition-all duration-200 hover:bg-primary-100">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    <span>Supplier</span>
                </a>
                <a href="notifications.html" class="flex items-center space-x-3 px-4 py-2 text-secondary-600 hover:bg-secondary-50 rounded-lg transition-all duration-200 hover:text-primary-600">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <span>Notifications</span>
                    <span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full">3</span>
                </a>
            </nav>

            <div class="absolute bottom-0 w-64 p-4 border-t border-secondary-200">
                <button onclick="logout()" class="flex items-center space-x-3 px-4 py-2 text-secondary-600 hover:bg-secondary-50 rounded-lg w-full transition-all duration-200 hover:text-primary-600">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    <span>Logout</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <header class="bg-white shadow-sm">
                <div class="px-8 py-4 flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <img src="school_logo.png" alt="School Logo" class="h-10">
                        <h1 class="text-xl font-semibold text-secondary-900">Supplier Management</h1>
                    </div>
                </div>
            </header>

            <main class="p-8">
                <!-- Controls -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <button onclick="showAddSupplierModal()" class="btn-primary flex items-center space-x-2" id="addSupplierButton">
                        <span>+</span>
                        <span>Add New Supplier</span>
                    </button>
                    <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                        <div class="relative flex-1 md:w-64">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-secondary-500">🔍</span>
                            </div>
                            <input type="text" id="searchInput" placeholder="Search suppliers..." 
                                class="input-field pl-10">
                        </div>
                    </div>
                </div>

                <!-- Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-secondary-200">
                            <thead class="bg-secondary-50">
                                <tr>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-secondary-500 uppercase tracking-wider">Company ID</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-secondary-500 uppercase tracking-wider">Company Name</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-secondary-500 uppercase tracking-wider">Contact Person</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-secondary-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-secondary-500 uppercase tracking-wider">Phone</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-secondary-500 uppercase tracking-wider">Address</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-secondary-500 uppercase tracking-wider actions-column">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="supplierTableBody" class="bg-white divide-y divide-secondary-200">
                                <!-- Table rows will be dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Supplier Modal -->
    <div id="supplierModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-secondary-900" id="modalTitle">Add New Supplier</h2>
                <button type="button" onclick="closeModal()" class="text-secondary-500 hover:text-secondary-700">&times;</button>
            </div>
            <form id="supplierForm" method="POST" action="/supplier/add" class="space-y-4" enctype="application/x-www-form-urlencoded">
                <div>
                    <label for="companyName" class="block text-sm font-medium text-secondary-700 mb-1">Company Name</label>
                    <input type="text" id="companyName" name="name" class="input-field" placeholder="Enter company name" required>
                </div>
                <div>
                    <label for="contactPerson" class="block text-sm font-medium text-secondary-700 mb-1">Contact Person</label>
                    <input type="text" id="contactPerson" name="contact" class="input-field" placeholder="Enter contact person's name">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-secondary-700 mb-1">Email Address</label>
                    <input type="email" id="email" name="email" class="input-field" placeholder="Enter email address">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium text-secondary-700 mb-1">Phone Number</label>
                    <input type="tel" id="phone" name="phone" class="input-field" placeholder="Enter phone number">
                </div>
                <div>
                    <label for="address" class="block text-sm font-medium text-secondary-700 mb-1">Complete Address</label>
                    <textarea id="address" name="address" class="input-field" placeholder="Enter complete address" rows="3"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Save Supplier</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="hidden"></div>
</body>
</html> 