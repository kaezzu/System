<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management - Colegio de Muntinlupa</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="shared.js"></script>
    <style>
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 40;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.07);
            background: #fff;
            transition: box-shadow 0.2s;
        }
        
        /* Toast notification styles */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 50;
            pointer-events: none;
        }
        
        .toast {
            transform: translateX(120%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: auto;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
            animation: pulse 2s infinite;
        }
        
        /* Sortable table styles */
        th.cursor-pointer {
            position: relative;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        th.cursor-pointer:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        th.cursor-pointer span {
            display: inline-block;
            font-size: 0.75rem;
            vertical-align: middle;
            margin-left: 0.25rem;
            color: #4F46E5; /* Primary color for better visibility */
        }
        
        /* Active sort column highlighting */
        th.active-sort {
            background-color: rgba(79, 70, 229, 0.05); /* Light primary color background */
            color: #4F46E5; /* Primary color text */
            font-weight: 600;
        }
        
        th.active-sort span {
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4);
            }
            70% {
                box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }
    </style>
    <script>
        // Make functions globally available
        (function(window) {
            const API_BASE_URL = 'http://localhost:3000';
            
            // Define sort state
            let currentSort = {
                column: 'product_id',  // Default sort column
                order: 'DESC'          // Default sort order
            };
            
            // Make sort state and function accessible globally
            window.currentSort = currentSort;
            window.sortItems = sortItems;

            // Define global functions
            window.showAddItemModal = function() {
                // Check if user has permission to add items
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                if (currentUser && currentUser.role === 'member') {
                    showToast('You do not have permission to add new items', 'error');
                    return;
                }
                
                const modal = document.getElementById('addItemModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.getElementById('addItemForm').reset();
            };

            window.closeModal = function() {
                document.getElementById('addItemModal').classList.add('hidden');
                document.getElementById('addItemModal').classList.remove('flex');
                
                // Reset form state
                const form = document.getElementById('addItemForm');
                form.reset();
                form.removeAttribute('data-item-id');
                
                // Reset modal title
                const modalTitle = document.querySelector('#addItemModal h2');
                if (modalTitle) {
                    modalTitle.textContent = 'Add New Item';
                }
                
                // Reset placeholders and dropdown text
                document.getElementById('itemName').placeholder = '';
                document.getElementById('itemQuantity').placeholder = '';
                document.getElementById('itemExpirationDate').value = ''; // Clear expiration date
                
                // Reset dropdown texts
                document.querySelector('#itemCategory option[value=""]').textContent = 'Select Category';
                document.querySelector('#itemStatus option[value=""]').textContent = 'Select Status';
                document.querySelector('#itemAvailability option[value=""]').textContent = 'Select Availability';
                
                // Reset submit button text
                const submitButton = document.querySelector('#addItemForm button[type="submit"]');
                if (submitButton) {
                    submitButton.textContent = 'Save Item';
                }
            };

            window.editItem = async function(id) {
                // Check if user has permission to edit items
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                if (currentUser && currentUser.role === 'member') {
                    showNotification('You do not have permission to edit items', 'error');
                    return;
                }
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/items/${id}`);
                    if (!response.ok) throw new Error('Failed to fetch item');
                    
                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to fetch item');
                    }

                    const item = data.item;
                    
                    // Update modal title to indicate we're editing
                    const modalTitle = document.querySelector('#addItemModal h2');
                    if (modalTitle) {
                        modalTitle.textContent = `Edit Item: ${item.name}`;
                    }
                    
                    // Set values for all form fields
                    document.getElementById('itemName').value = item.name || '';
                    document.getElementById('itemName').placeholder = `Current: ${item.name || 'None'}`;
                    
                    // Handle category dropdown
                    const categoryDropdown = document.getElementById('itemCategory');
                    let categoryFound = false;
                    
                    // First check if the category exists in the dropdown
                    for (let i = 0; i < categoryDropdown.options.length; i++) {
                        if (categoryDropdown.options[i].value === item.category) {
                            categoryDropdown.selectedIndex = i;
                            categoryFound = true;
                            break;
                        }
                    }
                    
                    // If category not found, add it to the dropdown
                    if (!categoryFound && item.category) {
                        // Create new option and insert before the "Add New" option
                        const newOption = document.createElement('option');
                        newOption.value = item.category;
                        newOption.textContent = item.category;
                        
                        // Insert before the last option (which is "Add New")
                        const addNewOption = categoryDropdown.querySelector('option[value="add_new_category"]');
                        categoryDropdown.insertBefore(newOption, addNewOption);
                        
                        // Select the new category
                        newOption.selected = true;
                    } else if (!categoryFound) {
                        // If no category, select the default blank option
                        categoryDropdown.selectedIndex = 0;
                    }
                    
                    // Update the empty option text
                    const emptyOption = categoryDropdown.querySelector('option[value=""]');
                    if (emptyOption) {
                        emptyOption.textContent = item.category ? `Current: ${item.category}` : 'Select Category';
                    }
                    
                    document.getElementById('itemStatus').value = item.status || '';
                    // Set a note for the status dropdown
                    const statusOption = Array.from(document.getElementById('itemStatus').options)
                        .find(option => option.value === '');
                    if (statusOption) {
                        statusOption.textContent = `Current: ${item.status || 'None'}`;
                    }
                    
                    document.getElementById('itemAvailability').value = item.availability || '';
                    // Set a note for the availability dropdown
                    const availabilityOption = Array.from(document.getElementById('itemAvailability').options)
                        .find(option => option.value === '');
                    if (availabilityOption) {
                        availabilityOption.textContent = `Current: ${item.availability || 'None'}`;
                    }
                    
                    document.getElementById('itemQuantity').value = item.quantity || 0;
                    document.getElementById('itemQuantity').placeholder = `Current: ${item.quantity || 0}`;
                    
                    document.getElementById('itemExpirationDate').value = item.expiration_date || '';
                    document.getElementById('itemExpirationDate').placeholder = `Current: ${item.expiration_date || 'None'}`;
                    
                    // Add hidden fields with current values
                    let hiddenFields = document.getElementById('hiddenFields');
                    if (!hiddenFields) {
                        hiddenFields = document.createElement('div');
                        hiddenFields.id = 'hiddenFields';
                        document.getElementById('addItemForm').appendChild(hiddenFields);
                    } else {
                        hiddenFields.innerHTML = ''; // Clear any existing hidden fields
                    }
                    
                    // Add hidden fields for each property
                    const properties = ['name', 'category', 'status', 'availability', 'quantity', 'expiration_date'];
                    properties.forEach(prop => {
                        const hiddenField = document.createElement('input');
                        hiddenField.type = 'hidden';
                        hiddenField.name = `original_${prop}`;
                        hiddenField.value = item[prop] || '';
                        hiddenFields.appendChild(hiddenField);
                    });
                    
                    // Store the item ID for update
                    document.getElementById('addItemForm').setAttribute('data-item-id', item.product_id);
                    
                    // Change the submit button text
                    const submitButton = document.querySelector('#addItemForm button[type="submit"]');
                    if (submitButton) {
                        submitButton.textContent = 'Update Item';
                    }
                    
                    showAddItemModal();
                } catch (error) {
                    console.error('Error editing item:', error);
                    showNotification('Error editing item', 'error');
                }
            };

            window.deleteItem = async function(id) {
                // Check if user has permission to delete items
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                if (currentUser && currentUser.role === 'member') {
                    showToast('You do not have permission to delete items', 'error');
                    return;
                }
                
                // Additional check for logistic officers
                if (currentUser && currentUser.role === 'logistic_officer') {
                    showToast('Logistic Officers cannot delete items', 'error');
                    return;
                }
                
                if (!confirm('Are you sure you want to delete this item?')) return;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/items/${id}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) throw new Error('Failed to delete item');
                    
                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to delete item');
                    }
                    
                    showNotification('Item deleted successfully');
                    loadItems();
                } catch (error) {
                    console.error('Error deleting item:', error);
                    showNotification('Error deleting item', 'error');
                }
            };

            window.showNotification = function(message, type = 'success') {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                
                // Set toast classes based on notification type
                const baseClasses = "toast shadow-lg rounded-md p-4 mb-3 flex items-center max-w-md";
                const typeClasses = type === 'success' 
                    ? "bg-green-600 text-white border-l-4 border-green-800"
                    : "bg-red-100 border-l-4 border-red-500 text-red-700";
                
                toast.className = `${baseClasses} ${typeClasses}`;
                
                // Set icon based on notification type
                const icon = type === 'success'
                    ? '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
                    : '<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
                
                toast.innerHTML = `
                    ${icon}
                    <div class="flex-1 font-medium">${message}</div>
                    <button class="ml-auto focus:outline-none ${type === 'success' ? 'text-white hover:text-gray-200' : 'text-gray-400 hover:text-gray-600'}" onclick="this.parentElement.remove()">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                
                // Add toast to container
                toastContainer.appendChild(toast);
                
                // Show toast with animation
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);
                
                // Auto-remove toast after 5 seconds
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        toast.remove();
                    }, 300); // Wait for fade-out animation
                }, 5000);
            };

            window.showQuantityModal = function(id, name, currentQuantity) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center';
                modal.id = 'quantityModal';
                
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 w-full max-w-md">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-semibold text-secondary-900">Manage Quantity: ${name}</h2>
                            <button onclick="closeQuantityModal()" class="text-secondary-500 hover:text-secondary-700">&times;</button>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <p class="text-sm text-secondary-600">Current Quantity: ${currentQuantity}</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-secondary-700 mb-1">Amount</label>
                                <input type="number" id="quantityAmount" min="1" value="1" class="input-field">
                            </div>
                            <div class="flex space-x-4">
                                <button onclick="updateQuantity(${id}, 'add')" class="flex-1 btn-primary bg-green-600 hover:bg-green-700">Add</button>
                                <button onclick="updateQuantity(${id}, 'remove')" class="flex-1 btn-primary bg-red-600 hover:bg-red-700">Remove</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            };

            window.closeQuantityModal = function() {
                const modal = document.getElementById('quantityModal');
                if (modal) {
                    modal.remove();
                }
            };

            window.updateQuantity = async function(id, action) {
                const amount = parseInt(document.getElementById('quantityAmount').value);
                if (!amount || amount <= 0) {
                    showNotification('Please enter a valid amount', 'error');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/items/${id}/quantity/${action}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ amount })
                    });

                    if (!response.ok) throw new Error('Failed to update quantity');
                    
                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to update quantity');
                    }
                    
                    // Create a detailed success message for quantity update
                    const itemName = document.querySelector('#quantityModal h2').textContent.replace('Manage Quantity: ', '');
                    const successMsg = `${action === 'add' ? 'Added' : 'Removed'} ${amount} units ${action === 'add' ? 'to' : 'from'} "${itemName}". New quantity: ${data.newQuantity}`;
                    
                    showNotification(successMsg);
                    closeQuantityModal();
                    loadItems();
                } catch (error) {
                    console.error('Error updating quantity:', error);
                    showNotification(error.message, 'error');
                }
            };

            window.showAddCategoryModal = function() {
                const modal = document.getElementById('categoryModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                document.getElementById('newCategoryName').focus();
            };

            window.closeCategoryModal = function() {
                document.getElementById('categoryModal').classList.add('hidden');
                document.getElementById('categoryModal').classList.remove('flex');
                document.getElementById('categoryForm').reset();
                
                // Reset the category dropdown to first option
                const categoryDropdown = document.getElementById('itemCategory');
                if (categoryDropdown) {
                    categoryDropdown.selectedIndex = 0;
                }
            };

            window.allInventoryItems = [];
            window.allCategories = [];

            async function loadItems() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/items?sort_by=${currentSort.column}&sort_order=${currentSort.order}`);
                    if (!response.ok) throw new Error('Failed to load items');
                    const data = await response.json();
                    if (!data.success) throw new Error(data.error || 'Failed to load items');
                    window.allInventoryItems = data.items; // Store all items globally
                    displayItems(window.allInventoryItems);
                } catch (error) {
                    console.error('Error loading items:', error);
                    showNotification('Error loading items', 'error');
                }
            }

            async function loadCategories() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/categories`);
                    if (!response.ok) throw new Error('Failed to load categories');
                    const categories = await response.json();
                    window.allCategories = categories;
                    updateCategoryDropdown();
                } catch (error) {
                    console.error('Error loading categories:', error);
                    showNotification('Error loading categories', 'error');
                }
            }

            function updateCategoryDropdown() {
                const categorySelect = document.getElementById('itemCategory');
                if (!categorySelect) return;
                // Save the "Add New" option if it exists
                const addNewOption = categorySelect.querySelector('option[value="add_new_category"]');
                // Clear and add the default option
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                // Add categories from global array
                window.allCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
                // Re-add the "Add New" option
                if (addNewOption) {
                    categorySelect.appendChild(addNewOption);
                } else {
                    const newOption = document.createElement('option');
                    newOption.value = 'add_new_category';
                    newOption.textContent = '+ Add New Category';
                    categorySelect.appendChild(newOption);
                }
            }

            // When a new category is added, update the global array and dropdown
            async function handleAddCategory(event) {
                event.preventDefault();
                const categoryName = document.getElementById('newCategoryName').value.trim();
                if (!categoryName) {
                    showNotification('Please enter a category name', 'error');
                    return;
                }
                try {
                    const response = await fetch(`${API_BASE_URL}/api/categories`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name: categoryName })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to add category');
                    }
                    const data = await response.json();
                    if (!data.id) {
                        throw new Error('Failed to add category');
                    }
                    // Update global categories and dropdown
                    window.allCategories.push({ id: data.id, name: categoryName });
                    updateCategoryDropdown();
                    showNotification(`Category "${categoryName}" ${data.alreadyExists ? 'selected' : 'added successfully'}`);
                    closeCategoryModal();
                } catch (error) {
                    console.error('Error adding category:', error);
                    showNotification(`Error adding category: ${error.message}`, 'error');
                }
            }

            // Internal functions
            function filterInventoryItems(searchTerm) {
                searchTerm = searchTerm.toLowerCase();
                return window.allInventoryItems.filter(item =>
                    (item.name && item.name.toLowerCase().includes(searchTerm)) ||
                    (item.product_id && item.product_id.toString().toLowerCase().includes(searchTerm)) ||
                    (item.category && item.category.toLowerCase().includes(searchTerm))
                );
            }

            async function handleAddItem(event) {
                event.preventDefault();
                
                const formData = new FormData(event.target);
                const itemId = event.target.getAttribute('data-item-id');
                const isEdit = !!itemId;
                
                let itemData = {};
                
                if (isEdit) {
                    // For edit mode, use original values if fields are empty
                    const fields = ['name', 'category', 'status', 'availability', 'quantity', 'expiration_date'];
                    
                    fields.forEach(field => {
                        const newValue = formData.get(field);
                        const originalValue = formData.get(`original_${field}`);
                        
                        // Use the new value if it's not empty, otherwise use the original
                        if (field === 'quantity') {
                            // Handle quantity specially to ensure it's a number
                            const newQuantity = newValue !== null && newValue !== '' ? parseInt(newValue) : null;
                            const origQuantity = originalValue !== null && originalValue !== '' ? parseInt(originalValue) : 0;
                            itemData[field] = newQuantity !== null ? newQuantity : origQuantity;
                        } else if (newValue === '' || newValue === null) {
                            // For empty/null values, use the original
                            itemData[field] = originalValue || null;
                        } else {
                            // Otherwise use the new value
                            itemData[field] = newValue;
                        }
                    });
                } else {
                    // For new items, just use the form data
                    itemData = {
                        name: formData.get('name'),
                        category: formData.get('category'),
                        status: formData.get('status'),
                        availability: formData.get('availability'),
                        quantity: formData.get('quantity'),
                        expiration_date: formData.get('expiration_date')
                    };
                }
                
                try {
                    const url = isEdit ? 
                        `${API_BASE_URL}/api/items/${itemId}` : 
                        `${API_BASE_URL}/api/items`;

                    const response = await fetch(url, {
                        method: isEdit ? 'PUT' : 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(itemData)
                    });

                    if (!response.ok) throw new Error(`Failed to ${isEdit ? 'update' : 'add'} item`);
                    
                    const data = await response.json();
                    if (!data.success) {
                        throw new Error(data.error || `Failed to ${isEdit ? 'update' : 'add'} item`);
                    }
                    
                    // Create a more detailed success message
                    const successMsg = isEdit 
                        ? `Item "${itemData.name}" updated successfully with quantity: ${itemData.quantity}`
                        : `Item "${itemData.name}" added successfully with quantity: ${itemData.quantity}`;
                    
                    showNotification(successMsg);
                    closeModal(); // This now fully resets the form
                    loadItems();
                } catch (error) {
                    console.error(`Error ${isEdit ? 'updating' : 'adding'} item:`, error);
                    showNotification(`Error ${isEdit ? 'updating' : 'adding'} item`, 'error');
                }
            }

            // Initialize when DOM is ready
            document.addEventListener('DOMContentLoaded', () => {
                // Check user role and hide Add New Item button if member
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                if (currentUser && currentUser.role === 'member') {
                    const addButton = document.querySelector('button[onclick="showAddItemModal()"]');
                    if (addButton) {
                        addButton.style.display = 'none';
                    }
                }
                
                // Load items and categories
                loadItems();
                loadCategories();
                
                
                // Add form submit event listener
                const form = document.getElementById('addItemForm');
                if (form) {
                    form.addEventListener('submit', handleAddItem);
                }
                
                // Add event listener for category dropdown
                const categoryDropdown = document.getElementById('itemCategory');
                if (categoryDropdown) {
                    categoryDropdown.addEventListener('change', function() {
                        if (this.value === 'add_new_category') {
                            // Show the add category modal
                            showAddCategoryModal();
                        }
                    });
                }
                
                // Add category filter event listener
                const categoryFilter = document.getElementById('categoryFilter');
                if (categoryFilter) {
                    categoryFilter.addEventListener('change', function() {
                        filterByCategory(this.value);
                    });
                }
                
                // Add search functionality
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', debounce((e) => {
                        const value = e.target.value.trim();
                        if (!value) {
                            displayItems(window.allInventoryItems);
                            return;
                        }
                        const filtered = filterInventoryItems(value);
                        displayItems(filtered);
                        if (filtered.length === 0) {
                            showNotification('No items found matching your search.', 'error');
                        }
                    }, 300));
                }
            });

            // Helper function to debounce search input
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Add this function to expose handleAddCategory to the global scope
            window.handleAddCategory = handleAddCategory;

            // Sort function for items
            function sortItems(column) {
                // If same column, toggle the order
                if (currentSort.column === column) {
                    currentSort.order = currentSort.order === 'ASC' ? 'DESC' : 'ASC';
                } else {
                    // If new column, set it and default to ASC
                    currentSort.column = column;
                    currentSort.order = 'ASC';
                }
                
                // Reload items with new sort
                loadItems();
            }
            
            // Update sort indicators in the table header
            function updateSortIndicators() {
                // First clear all indicators and active classes
                document.querySelectorAll('span[id^="sort-"]').forEach(span => {
                    span.innerHTML = '';
                    // Remove active class from parent th element
                    const th = span.closest('th');
                    if (th) {
                        th.classList.remove('active-sort');
                    }
                });
                
                // Set the current sort indicator
                const indicatorSpan = document.getElementById(`sort-${currentSort.column}`);
                if (indicatorSpan) {
                    // Use arrow indicators for sort direction
                    indicatorSpan.innerHTML = currentSort.order === 'ASC' 
                        ? '&#9650;' // Up arrow for ascending
                        : '&#9660;' // Down arrow for descending
                    
                    // Add active class to highlight the sorted column
                    const th = indicatorSpan.closest('th');
                    if (th) {
                        th.classList.add('active-sort');
                    }
                }
            }

            // Function to filter by category
            async function filterByCategory(category) {
                try {
                    // If no category selected, just use the normal sort
                    if (!category) {
                        loadItems();
                        return;
                    }
                    
                    // Get items with current sort and filter by category client-side
                    const response = await fetch(`${API_BASE_URL}/api/items?sort_by=${currentSort.column}&sort_order=${currentSort.order}`);
                    if (!response.ok) throw new Error('Failed to load items');
                    const data = await response.json();
                    
                    if (!data.success) {
                        throw new Error(data.error || 'Failed to load items');
                    }
                    
                    // Filter items by category
                    const filteredItems = data.items.filter(item => item.category === category);
                    
                    // Update the table with filtered items
                    displayItems(filteredItems);
                } catch (error) {
                    console.error('Error filtering by category:', error);
                    showNotification('Error filtering items', 'error');
                }
            }
            
            // Function to display items (separate from loadItems to reuse code)
            function displayItems(items) {
                const tableBody = document.getElementById('inventoryTableBody');
                if (!tableBody) {
                    console.error('Could not find inventory table body');
                    return;
                }
                tableBody.innerHTML = '';
                
                // Update sort indicators
                updateSortIndicators();
                
                // Get current user role
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                const isMember = currentUser && currentUser.role === 'member';
                const isLogisticOfficer = currentUser && currentUser.role === 'logistic_officer';
                
                items.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Create base row content
                    row.innerHTML = `
                        <td class="px-6 py-4 text-center">${item.product_id}</td>
                        <td class="px-6 py-4 text-center">${item.name}</td>
                        <td class="px-6 py-4 text-center">${item.category || '-'}</td>
                        <td class="px-6 py-4 text-center">${item.status}</td>
                        <td class="px-6 py-4 text-center">${item.availability}</td>
                        <td class="px-6 py-4 text-center">${item.quantity || 0}</td>
                        <td class="px-6 py-4 text-center">${item.expiration_date || '-'}</td>
                    `;
                    
                    // Add action buttons cell - only if not a member
                    const actionsCell = document.createElement('td');
                    actionsCell.className = "px-6 py-4 text-center";
                    
                    if (!isMember) {
                        // Create different action buttons based on user role
                        let actionsHtml = `
                            <div class="flex items-center justify-center space-x-3">
                                <button onclick="editItem(${item.product_id})"
                                    class="inline-flex items-center justify-center px-2 py-1.5 border border-blue-600 text-blue-600 hover:bg-blue-50 rounded-md transition-colors duration-150"
                                    title="Edit Item"
                                    aria-label="Edit Item">
                                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>`;
                                    
                                // Only show delete button if user is NOT a logistic officer
                                if (!isLogisticOfficer) {
                                    actionsHtml += `
                                        <button onclick="deleteItem(${item.product_id})"
                                            class="inline-flex items-center justify-center px-2 py-1.5 border border-red-600 text-red-600 hover:bg-red-50 rounded-md transition-colors duration-150"
                                            title="Delete Item"
                                            aria-label="Delete Item">
                                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>`;
                                } else {
                                    // For logistic officers, show a disabled delete button or informational text
                                    actionsHtml += `
                                        <button disabled
                                            class="inline-flex items-center justify-center px-2 py-1.5 text-gray-400 cursor-not-allowed rounded-md"
                                            title="Delete not allowed for Logistic Officers"
                                            aria-label="Delete not allowed">
                                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>`;
                                }
                                    
                                actionsHtml += `
                                    <button onclick="showQuantityModal(${item.product_id}, '${item.name}', ${item.quantity || 0})"
                                        class="inline-flex items-center justify-center px-2 py-1.5 border border-green-600 text-green-600 hover:bg-green-50 rounded-md transition-colors duration-150"
                                        title="Manage Quantity"
                                        aria-label="Manage Quantity">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                    </button>
                                </div>`;
                                
                                actionsCell.innerHTML = actionsHtml;
                            } else {
                                // For members, just display "No actions available"
                                actionsCell.innerHTML = `<span class="text-gray-400 text-sm">No actions available</span>`;
                            }
                            
                            row.appendChild(actionsCell);
                            tableBody.appendChild(row);
                        });
                    }
                }
            
        )(window);

    // Sticky header on scroll
    document.addEventListener('DOMContentLoaded', function() {
        const header = document.querySelector('header');
        const stickyClass = 'sticky-header';
        window.addEventListener('scroll', function() {
            if (window.scrollY > 0) {
                header.classList.add(stickyClass);
            } else {
                header.classList.remove(stickyClass);
            }
        });
    });
    </script>
</head>
<body class="min-h-screen bg-secondary-50">
    <script>
        // Check if user is logged in
        if (!sessionStorage.getItem('isLoggedIn')) {
            window.location.href = 'index.html';
        }
    </script>

    <!-- Toast container for notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-lg">
            <div class="h-28 flex items-center border-b border-secondary-200 px-4 pt-6 pb-6" style="padding-top: 6px; padding-bottom: 6px;">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center text-primary-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="font-medium text-secondary-900" id="sidebarUserName">Loading...</p>
                        <p class="text-sm text-secondary-600" id="sidebarUserRole">Loading...</p>
                        <p class="text-xs text-secondary-500" id="sidebarUserFullName">Loading...</p>
                    </div>
                </div>
            </div>

            <nav class="p-4 space-y-2">
                <a href="dashboard.html" class="flex items-center space-x-3 px-4 py-2 text-secondary-600 hover:bg-secondary-50 rounded-lg transition-all duration-200 hover:text-primary-600">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    <span>Home</span>
                </a>
                <a href="inventory.html" class="flex items-center space-x-3 px-4 py-2 bg-primary-50 text-primary-700 rounded-lg transition-all duration-200 hover:bg-primary-100">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    <span>Inventory</span>
                </a>
                <a href="borrowed.html" class="flex items-center space-x-3 px-4 py-2 text-secondary-600 hover:bg-secondary-50 rounded-lg transition-all duration-200 hover:text-primary-600">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    <span>Borrowed Items</span>
                </a>
                <a href="user-activity.html" class="flex items-center space-x-3 px-4 py-2 text-secondary-600 hover:bg-secondary-50 rounded-lg transition-all duration-200 hover:text-primary-600">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <span>User Activity</span>
                </a>
                <a href="supplier.html" class="flex items-center space-x-3 px-4 py-2 text-secondary-600 hover:bg-secondary-50 rounded-lg transition-all duration-200 hover:text-primary-600">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                    </svg>
                    <span>Supplier</span>
                </a>
                <a href="notifications.html" class="flex items-center space-x-3 px-4 py-2 text-secondary-600 hover:bg-secondary-50 rounded-lg transition-all duration-200 hover:text-primary-600">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <span>Notifications</span>
                </a>
                <a href="notes.html" class="flex items-center space-x-3 px-4 py-2 text-secondary-600 hover:bg-secondary-50 rounded-lg transition-all duration-200 hover:text-primary-600">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h10M7 11h10M7 15h6M5 5v14a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2z"/>
                    </svg>
                    <span>Notes</span>
                </a>
            </nav>

            <div class="absolute bottom-0 w-64 p-4 border-t border-secondary-200">
                <button onclick="logout()" class="flex items-center space-x-3 px-4 py-2 text-secondary-600 hover:bg-secondary-50 rounded-lg w-full transition-all duration-200 hover:text-primary-600">
                    <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    <span>Logout</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-auto">
            <header class="bg-white shadow-sm">
                <div class="px-8 py-4 flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <img src="img/school_logo.png" alt="School Logo" class="h-10">
                        <h1 class="text-xl font-semibold text-secondary-900">Inventory Management</h1>
                    </div>
                
                </div>
            </header>

            <main class="p-8">
                <!-- Controls -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                    <button onclick="showAddItemModal()" class="btn-primary flex items-center space-x-2">
                        <span>+</span>
                        <span>Add New Item</span>
                    </button>
                    <div class="flex flex-col md:flex-row gap-4 w-full md:w-auto">
                        <div class="relative flex-1 md:w-64">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="w-4 h-4 text-secondary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 104.5 4.5a7.5 7.5 0 0012.15 12.15z" />
                                </svg>
                            </div>
                            <input type="text" id="searchInput" placeholder="Search items..." 
                                class="input-field pl-10">
                        </div>
                        <select id="categoryFilter" class="input-field md:w-48">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                </div>

                <!-- Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-secondary-200">
                            <thead class="bg-secondary-50">
                                <tr>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-secondary-500 uppercase tracking-wider cursor-pointer hover:bg-secondary-100" onclick="sortItems('product_id')">
                                            Product ID
                                            <span id="sort-product_id" class="inline-block ml-1"></span>
                                        </th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-secondary-500 uppercase tracking-wider cursor-pointer hover:bg-secondary-100" onclick="sortItems('name')">
                                            Name
                                            <span id="sort-name" class="inline-block ml-1"></span>
                                        </th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-secondary-500 uppercase tracking-wider cursor-pointer hover:bg-secondary-100" onclick="sortItems('category')">
                                            Category
                                            <span id="sort-category" class="inline-block ml-1"></span>
                                        </th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-secondary-500 uppercase tracking-wider cursor-pointer hover:bg-secondary-100" onclick="sortItems('status')">
                                            Status
                                            <span id="sort-status" class="inline-block ml-1"></span>
                                        </th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-secondary-500 uppercase tracking-wider cursor-pointer hover:bg-secondary-100" onclick="sortItems('availability')">
                                            Availability
                                            <span id="sort-availability" class="inline-block ml-1"></span>
                                        </th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-secondary-500 uppercase tracking-wider cursor-pointer hover:bg-secondary-100" onclick="sortItems('quantity')">
                                            Quantity
                                            <span id="sort-quantity" class="inline-block ml-1"></span>
                                        </th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-secondary-500 uppercase tracking-wider cursor-pointer hover:bg-secondary-100" onclick="sortItems('expiration_date')">
                                            Expiration Date
                                            <span id="sort-expiration_date" class="inline-block ml-1"></span>
                                        </th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-secondary-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody" class="bg-white divide-y divide-secondary-200">
                                <!-- Table rows will be dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="addItemModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-secondary-900">Add New Item</h2>
                <button onclick="closeModal()" class="text-secondary-500 hover:text-secondary-700">&times;</button>
            </div>
            <form id="addItemForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-secondary-700 mb-1">Item Name</label>
                    <input type="text" id="itemName" name="name" class="input-field" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-secondary-700 mb-1">Category</label>
                    <select id="itemCategory" name="category" class="input-field" required>
                        <option value="">Select Category</option>
                        <option value="Medical Supplies">Medical Supplies</option>
                        <option value="Communication">Communication</option>
                        <option value="PPE">PPE</option>
                        <option value="Specialized Equipment">Specialized Equipment</option>
                        <option value="add_new_category">+ Add New Category</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-secondary-700 mb-1">Status</label>
                    <select id="itemStatus" name="status" class="input-field" required>
                        <option value="">Select Status</option>
                        <option value="Available">Available</option>
                        <option value="In Use">In Use</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Retired">Retired</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-secondary-700 mb-1">Availability</label>
                    <select id="itemAvailability" name="availability" class="input-field" required>
                        <option value="">Select Availability</option>
                        <option value="In Stock">In Stock</option>
                        <option value="Out of Stock">Out of Stock</option>
                        <option value="Limited">Limited</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-secondary-700 mb-1">Initial Quantity</label>
                    <input type="number" id="itemQuantity" name="quantity" class="input-field" min="0" value="0" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-secondary-700 mb-1">Expiration Date</label>
                    <input type="date" id="itemExpirationDate" name="expiration_date" class="input-field">
                </div>
                <button type="submit" class="w-full btn-primary">Save Item</button>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="categoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-secondary-900">Add New Category</h2>
                <button onclick="closeCategoryModal()" class="text-secondary-500 hover:text-secondary-700">&times;</button>
            </div>
            <form id="categoryForm" onsubmit="handleAddCategory(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-secondary-700 mb-1">Category Name</label>
                    <input type="text" id="newCategoryName" class="input-field" placeholder="Enter category name" required>
                </div>
                <button type="submit" class="w-full btn-primary">Add Category</button>
            </form>
        </div>
    </div>
</body>
</html> 